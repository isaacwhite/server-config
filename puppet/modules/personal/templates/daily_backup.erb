#!/bin/bash
# Proper header for a Bash script.

now="$(date +'%c')"
echo "Backup script running at $now"

# DB and file backup
MYSQL_PWD="<% @mysql_root %>"
AWS_ACCESS_KEY_ID="<% @s3_key %>"
AWS_SECRET_ACCESS_KEY="<% @s3_secret %>"

OUTPUT_DIR=/home/<% @username %>/s3_prep
SITES_DIR=/home/<% @username %>/sites
FILES_PATH=sites/default/

# db dumps
echo "Beginning database backups..."
mysqldump -u root -h localhost -p$MYSQL_PWD mytimes | gzip -9 > /$OUTPUT_DIR/dbs/mytimes.sql.gz
mysqldump -u root -h localhost -p$MYSQL_PWD hoffman_dev | gzip -9 > /$OUTPUT_DIR/dbs/hoffman_dev.sql.gz
mysqldump -u root -h localhost -p$MYSQL_PWD scylla | gzip -9 > /$OUTPUT_DIR/dbs/scylla.sql.gz
mysqldump -u root -h localhost -p$MYSQL_PWD jrw_dev | gzip -9 > /$OUTPUT_DIR/dbs/jrw_dev.sql.gz

echo "Starting file backups..."
# file backups
cd $SITES_DIR/dev.solomonhoffman.com/$FILES_PATH
tar -czf $OUTPUT_DIR/files/hoffman_dev_files.tar.gz files

cd $SITES_DIR/dev.joshuarobertwhite.com/$FILES_PATH
tar -czf $OUTPUT_DIR/files/jrw_dev_files.tar.gz files

cd $SITES_DIR/mytimes.isaacwhite.com/$FILES_PATH
tar -czf $OUTPUT_DIR/files/mytimes_files.tar.gz files

echo "Uploading to s3..."
#upload to s3
/usr/local/bin/aws s3 sync $OUTPUT_DIR s3://s1.isaacwhite.com

echo "Script completed."
exit #  The right and proper method of "exiting" from a script.
     #  A bare "exit" (no parameter) returns the exit status
     #+ of the preceding command. 
